name: Update *.metadata.txt after merge (API) -> PR

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  post_merge_metadata:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base branch (default)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Checkout merge commit
        id: shas
        shell: bash
        run: |
          set -euo pipefail
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          echo "MERGE_SHA=$MERGE_SHA"

          git fetch --no-tags origin "$MERGE_SHA"
          git checkout "$MERGE_SHA"

          # 이 merge가 도입한 변경만 보려면 merge commit의 부모를 base로 잡는 게 안전
          BASE_SHA="$(git rev-parse "$MERGE_SHA^")"
          echo "BASE_SHA=$BASE_SHA" >> "$GITHUB_OUTPUT"
          echo "HEAD_SHA=$MERGE_SHA" >> "$GITHUB_OUTPUT"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OpenAI SDK
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade openai

      - name: Run metadata manager in diff mode (post-merge)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5.2-pro
          MODE: diff
          BASE_SHA: ${{ steps.shas.outputs.BASE_SHA }}
          HEAD_SHA: ${{ steps.shas.outputs.HEAD_SHA }}
          MAX_RS_LINES: "2000"
          MAX_META_LINES: "6000"
          MAX_WORKERS: "4"
          RETRY_MAX: "5"
        run: |
          python scripts/metadata_manager.py

      - name: Build unique branch suffix (datetime)
        id: ts
        run: echo "ts=$(date -u +'%Y%m%d-%H%M%S')" >> "$GITHUB_OUTPUT"

      - name: Create PR with updated metadata
        uses: peter-evans/create-pull-request@v6
        with:
          branch: bot/metadata-post-merge-pr${{ github.event.pull_request.number }}-${{ steps.ts.outputs.ts }}
          title: "Post-merge: update rust metadata files"
          commit-message: "chore: post-merge update rust metadata"
          body: |
            Auto-updated *.metadata.txt after PR #${{ github.event.pull_request.number }} merged.
          add-paths: |
            **/*.metadata.txt
