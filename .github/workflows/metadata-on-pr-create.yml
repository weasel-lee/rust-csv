name: Generate *.metadata.txt once per PR (API)

on:
  pull_request:
    types: [opened, ready_for_review]

permissions:
  contents: write

concurrency:
  group: metadata-once-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  gen_metadata:
    if: >
      github.event.pull_request.head.repo.fork == false &&
      github.actor != 'github-actions[bot]' &&
      (
        (github.event.action == 'opened' && github.event.pull_request.draft == false) ||
        (github.event.action == 'ready_for_review')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR head (so we can push commits)
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Skip if already ran for this PR
        id: stamp
        shell: bash
        run: |
          set -euo pipefail
          STAMP=".github/metadata/.stamp_pr_${{ github.event.pull_request.number }}"
          if [ -f "$STAMP" ]; then
            echo "already=true" >> "$GITHUB_OUTPUT"
            echo "Already ran (stamp exists): $STAMP"
          else
            echo "already=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Python
        if: ${{ steps.stamp.outputs.already != 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OpenAI SDK
        if: ${{ steps.stamp.outputs.already != 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade openai

      - name: Run metadata manager (diff A/M/D handling, parallel)
        if: ${{ steps.stamp.outputs.already != 'true' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-5.2-pro
          MODE: diff
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          MAX_RS_LINES: "2000"
          MAX_META_LINES: "6000"
          MAX_WORKERS: "4"
          RETRY_MAX: "5"
        run: |
          python scripts/metadata_manager.py

      - name: Write stamp
        if: ${{ steps.stamp.outputs.already != 'true' }}
        run: |
          mkdir -p .github/metadata
          echo "ran at $(date -u +%FT%TZ)" > ".github/metadata/.stamp_pr_${{ github.event.pull_request.number }}"

      - name: Commit & push changes (*.metadata.txt + deletions + stamp)
        if: ${{ steps.stamp.outputs.already != 'true' }}
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: update rust metadata (once per PR)"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
